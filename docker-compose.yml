services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped

  redis_analytics:
      image: redis:7-alpine
      command: >
        redis-server --save "" --appendonly no --maxmemory 512mb --maxmemory-policy allkeys-lru
      ports: ["6380:6379"]


  anticip8-core:
    build: ./core
    environment:
      REDIS_URL: redis://redis:6379/0
      # Battle-tuned defaults: avoid empty policies + make prefetch actually happen.
      MIN_PROB: "0.001"
      MARKOV_SMOOTH: "1.0"
      MAX_PREFETCH: "3"
      PREFETCH_BUDGET_MS: "350"

      SERVICE_BIAS: "orders-api=1.0,options-api=0.7"
      CROSS_SERVICE_PENALTY: "0.85"
      INTRA_SERVICE_BOOST: "0.10"
      TIER1_INTRA_FIRST: "1"
      POLICY_DENY_REGEX: "/cancel|/payment"

    depends_on: [redis]
    ports: ["18000:8000"]

  orders-api:
    build:
      context: .
      dockerfile: services/orders_api/Dockerfile
    environment:
      SERVICE_NAME: orders-api
      ANTICIP8_CHAINLOG: 1
      ANTICIP8_CORE_URL: http://anticip8-core:8000
      OPTIONS_BASE_URL: http://options-api:8000
      ANTICIP8_ANALYTICS_REDIS_URL: redis://redis_analytics:6379/0
      ANTICIP8_INTENT_TTL_SEC: 120
      ANTICIP8_PREFETCH_MARK_TTL_SEC: 40
      ANTICIP8_PREFETCH_MAX_BATCH_INFLIGHT: "1"
      ANTICIP8_PREFETCH_PER_REQUEST_TIMEOUT_SEC: "0.45"
      ANTICIP8_MIN_PREFETCH_WINDOW_SEC: "0.06"
      ANTICIP8_PREFETCH_MAX_CONCURRENCY: "2"
      ANTICIP8_QUERY_MODE: ignore
      ANTICIP8_LOG_REAL: 1
      ANTICIP8_LOG_PREFETCH: 1
      ANTICIP8_LOG_HITMISS: 1
      # ANTICIP8_LOG_ONLY_USER: u254
      ANTICIP8_LOG_SAMPLE: 1
      ANTICIP8_RACE_GRACE_MS: 80
      ANTICIP8_RACE_GRACE_MAX_MS: 120
    depends_on: [anticip8-core]
    ports: 
      - "18001:8000"

  options-api:
    build:
      context: .
      dockerfile: services/options_api/Dockerfile
    environment:
      SERVICE_NAME: options-api
      ANTICIP8_INTENT_TTL_SEC: 120
      ANTICIP8_PREFETCH_MARK_TTL_SEC: 40
      ANTICIP8_CHAINLOG: 1
      ANTICIP8_CORE_URL: http://anticip8-core:8000
      ANTICIP8_PREFETCH_MAX_BATCH_INFLIGHT: "1"
      ANTICIP8_ANALYTICS_REDIS_URL: redis://redis_analytics:6379/0
      ANTICIP8_PREFETCH_PER_REQUEST_TIMEOUT_SEC: "0.45"
      ANTICIP8_MIN_PREFETCH_WINDOW_SEC: "0.06"
      ANTICIP8_PREFETCH_MAX_CONCURRENCY: "2"
      ANTICIP8_QUERY_MODE: ignore
      ANTICIP8_LOG_REAL: 1
      ANTICIP8_LOG_PREFETCH: 1
      ANTICIP8_LOG_HITMISS: 1
      # ANTICIP8_LOG_ONLY_USER: u254
      ANTICIP8_LOG_SAMPLE: 1
      ANTICIP8_RACE_GRACE_MS: 80
      ANTICIP8_RACE_GRACE_MAX_MS: 120
    depends_on: [anticip8-core]
    ports: 
      - "18002:8000"

  orders-api-baseline:
    build:
      context: .
      dockerfile: services/orders_api_baseline/Dockerfile
    environment:
      SERVICE_NAME: orders-api-baseline
      CACHE_MODE: IO_CACHE   # или NO_CACHE
      REDIS_URL: redis://redis:6379/1
    depends_on: [redis]
    ports:
      - "28001:8000"

  options-api-baseline:
    build:
      context: .
      dockerfile: services/options_api_baseline/Dockerfile
    environment:
      SERVICE_NAME: options-api-baseline
      CACHE_MODE: IO_CACHE   # или NO_CACHE
      REDIS_URL: redis://redis:6379/1
    depends_on: [redis]
    ports:
      - "28002:8000"

  locust:
    build: ./locust
    environment:
      ORDERS_BASE_URL: http://orders-api:8000
      OPTIONS_BASE_URL: http://options-api:8000
    depends_on: [orders-api, options-api]
    ports: ["18089:8089"]

  locust-baseline:
    build: ./locust
    environment:
      ORDERS_BASE_URL: http://orders-api-baseline:8000
      OPTIONS_BASE_URL: http://options-api-baseline:8000
    depends_on: [orders-api-baseline, options-api-baseline]
    ports:
      - "18090:8089"

  prometheus:
    image: prom/prometheus:v2.52.0
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: ["19090:9090"]
    depends_on: [anticip8-core, orders-api, options-api]


  grafana:
    image: grafana/grafana:10.4.3
    ports: ["13000:3000"]
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on: [prometheus]

  anticip8-analytics:
      build: ./analytics
      environment:
        - ANTICIP8_ANALYTICS_REDIS_URL=redis://redis_analytics:6379/0
      ports:
        - "8010:8000"
      depends_on:
        - redis